<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>quarto-input6a06c2eb473dceb4 – 金融工学ノート</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-e31584831b205ffbb2d98406f31c2a5b.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">金融工学ノート</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">ホーム</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./03-portfolio.html"> 
<span class="menu-text">ポートフォリオ理論</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./04-capm.qmd"> 
<span class="menu-text">CAPM</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#期待値expected-value-mean" id="toc-期待値expected-value-mean" class="nav-link active" data-scroll-target="#期待値expected-value-mean">期待値（Expected Value / Mean）</a></li>
  <li><a href="#分散varianceと標準偏差stdard-deviation" id="toc-分散varianceと標準偏差stdard-deviation" class="nav-link" data-scroll-target="#分散varianceと標準偏差stdard-deviation">分散（Variance）と標準偏差（Stdard Deviation）</a></li>
  <li><a href="#共分散covariance" id="toc-共分散covariance" class="nav-link" data-scroll-target="#共分散covariance">共分散（Covariance）</a></li>
  <li><a href="#相関correlation" id="toc-相関correlation" class="nav-link" data-scroll-target="#相関correlation">相関（Correlation）</a></li>
  <li><a href="#概要" id="toc-概要" class="nav-link" data-scroll-target="#概要">概要</a></li>
  <li><a href="#基本的考え方" id="toc-基本的考え方" class="nav-link" data-scroll-target="#基本的考え方">基本的考え方</a></li>
  <li><a href="#前提条件" id="toc-前提条件" class="nav-link" data-scroll-target="#前提条件">前提条件</a></li>
  <li><a href="#効率的ポートフォリオefficient-portfolio" id="toc-効率的ポートフォリオefficient-portfolio" class="nav-link" data-scroll-target="#効率的ポートフォリオefficient-portfolio">効率的ポートフォリオ（Efficient Portfolio）</a></li>
  <li><a href="#ポートフォリオの前提" id="toc-ポートフォリオの前提" class="nav-link" data-scroll-target="#ポートフォリオの前提">ポートフォリオの前提</a></li>
  <li><a href="#基本パラメータ" id="toc-基本パラメータ" class="nav-link" data-scroll-target="#基本パラメータ">基本パラメータ</a></li>
  <li><a href="#リターンの定義" id="toc-リターンの定義" class="nav-link" data-scroll-target="#リターンの定義">リターンの定義</a></li>
  <li><a href="#重要点" id="toc-重要点" class="nav-link" data-scroll-target="#重要点">重要点</a></li>
  <li><a href="#前提" id="toc-前提" class="nav-link" data-scroll-target="#前提">前提</a></li>
  <li><a href="#定義" id="toc-定義" class="nav-link" data-scroll-target="#定義">定義</a></li>
  <li><a href="#数式" id="toc-数式" class="nav-link" data-scroll-target="#数式">数式</a></li>
  <li><a href="#ポイント" id="toc-ポイント" class="nav-link" data-scroll-target="#ポイント">ポイント</a></li>
  <li><a href="#共分散" id="toc-共分散" class="nav-link" data-scroll-target="#共分散">共分散</a></li>
  <li><a href="#共分散行列-σ" id="toc-共分散行列-σ" class="nav-link" data-scroll-target="#共分散行列-σ">共分散行列 Σ</a></li>
  <li><a href="#ポートフォリオ分散" id="toc-ポートフォリオ分散" class="nav-link" data-scroll-target="#ポートフォリオ分散">ポートフォリオ分散</a></li>
  <li><a href="#標準偏差リスク" id="toc-標準偏差リスク" class="nav-link" data-scroll-target="#標準偏差リスク">標準偏差（リスク）</a></li>
  <li><a href="#ポイント-1" id="toc-ポイント-1" class="nav-link" data-scroll-target="#ポイント-1">ポイント</a></li>
  <li><a href="#効率的フロンティアとは" id="toc-効率的フロンティアとは" class="nav-link" data-scroll-target="#効率的フロンティアとは">効率的フロンティアとは</a></li>
  <li><a href="#投資家の選択" id="toc-投資家の選択" class="nav-link" data-scroll-target="#投資家の選択">投資家の選択</a></li>
  <li><a href="#結論" id="toc-結論" class="nav-link" data-scroll-target="#結論">結論</a></li>
  <li><a href="#特徴" id="toc-特徴" class="nav-link" data-scroll-target="#特徴">特徴</a></li>
  <li><a href="#数式-1" id="toc-数式-1" class="nav-link" data-scroll-target="#数式-1">数式</a></li>
  <li><a href="#解釈の目安" id="toc-解釈の目安" class="nav-link" data-scroll-target="#解釈の目安">解釈の目安</a></li>
  <li><a href="#python実装例" id="toc-python実装例" class="nav-link" data-scroll-target="#python実装例">Python実装例</a></li>
  <li><a href="#特徴-1" id="toc-特徴-1" class="nav-link" data-scroll-target="#特徴-1">特徴</a></li>
  <li><a href="#考え方" id="toc-考え方" class="nav-link" data-scroll-target="#考え方">考え方</a></li>
  <li><a href="#数式-2" id="toc-数式-2" class="nav-link" data-scroll-target="#数式-2">数式</a></li>
  <li><a href="#python実装例-1" id="toc-python実装例-1" class="nav-link" data-scroll-target="#python実装例-1">Python実装例</a></li>
  <li><a href="#特徴-2" id="toc-特徴-2" class="nav-link" data-scroll-target="#特徴-2">特徴</a></li>
  <li><a href="#使用ライブラリ" id="toc-使用ライブラリ" class="nav-link" data-scroll-target="#使用ライブラリ">使用ライブラリ</a></li>
  <li><a href="#手順" id="toc-手順" class="nav-link" data-scroll-target="#手順">手順</a></li>
  <li><a href="#python実装例-2" id="toc-python実装例-2" class="nav-link" data-scroll-target="#python実装例-2">Python実装例</a></li>
  <li><a href="#特徴-3" id="toc-特徴-3" class="nav-link" data-scroll-target="#特徴-3">特徴</a></li>
  <li><a href="#数式と定義" id="toc-数式と定義" class="nav-link" data-scroll-target="#数式と定義">数式と定義</a></li>
  <li><a href="#python実装例-3" id="toc-python実装例-3" class="nav-link" data-scroll-target="#python実装例-3">Python実装例</a></li>
  <li><a href="#特徴-4" id="toc-特徴-4" class="nav-link" data-scroll-target="#特徴-4">特徴</a></li>
  <li><a href="#数式-3" id="toc-数式-3" class="nav-link" data-scroll-target="#数式-3">数式</a></li>
  <li><a href="#python実装例-4" id="toc-python実装例-4" class="nav-link" data-scroll-target="#python実装例-4">Python実装例</a></li>
  <li><a href="#特徴-5" id="toc-特徴-5" class="nav-link" data-scroll-target="#特徴-5">特徴</a></li>
  <li><a href="#数式-4" id="toc-数式-4" class="nav-link" data-scroll-target="#数式-4">数式</a></li>
  <li><a href="#python実装例-5" id="toc-python実装例-5" class="nav-link" data-scroll-target="#python実装例-5">Python実装例</a></li>
  <li><a href="#特徴-6" id="toc-特徴-6" class="nav-link" data-scroll-target="#特徴-6">特徴</a></li>
  <li><a href="#実行結果の例" id="toc-実行結果の例" class="nav-link" data-scroll-target="#実行結果の例">実行結果の例</a></li>
  <li><a href="#python実装例-6" id="toc-python実装例-6" class="nav-link" data-scroll-target="#python実装例-6">Python実装例</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block"></header>




<p>#3 現代ポートフォリオ理論</p>
<p>##3-1 統計的基礎：期待値・分散・共分散・相関</p>
<section id="期待値expected-value-mean" class="level3">
<h3 class="anchored" data-anchor-id="期待値expected-value-mean">期待値（Expected Value / Mean）</h3>
<ul>
<li>平均的な結果を表す。</li>
<li>式： <span class="math display">\[E[X] = \sum_i x_i p_i\]</span></li>
<li>例：
<ul>
<li>サイコロ：期待値 = 3.5</li>
<li>ルーレット：期待値 &lt; 0（長期的には損をする）</li>
</ul></li>
</ul>
<hr>
</section>
<section id="分散varianceと標準偏差stdard-deviation" class="level3">
<h3 class="anchored" data-anchor-id="分散varianceと標準偏差stdard-deviation">分散（Variance）と標準偏差（Stdard Deviation）</h3>
<ul>
<li>データの散らばりを表す。</li>
<li>式： <span class="math display">\[Var(X) = E[(X-\mu)^2]\]</span></li>
<li>標準偏差 = 分散の平方根。</li>
</ul>
<hr>
</section>
<section id="共分散covariance" class="level3">
<h3 class="anchored" data-anchor-id="共分散covariance">共分散（Covariance）</h3>
<ul>
<li>2変数の一緒の動きを測る。</li>
<li>式： <span class="math display">\[Cov(X,Y) = E[(X-\mu_X)(Y-\mu_Y)]\]</span></li>
<li>問題点：次元依存・比較が困難。</li>
</ul>
<hr>
</section>
<section id="相関correlation" class="level3">
<h3 class="anchored" data-anchor-id="相関correlation">相関（Correlation）</h3>
<ul>
<li>共分散を標準偏差で正規化。</li>
<li>値域：[-1, +1]
<ul>
<li>+1 → 正の相関</li>
<li>-1 → 負の相関</li>
<li>0 → 無相関</li>
</ul></li>
<li>ポートフォリオ最適化では「相関が小さい銘柄の組み合わせ」が有効。</li>
</ul>
<p>##3-2 モダン・ポートフォリオ理論（Markowitz Model）</p>
</section>
<section id="概要" class="level3">
<h3 class="anchored" data-anchor-id="概要">概要</h3>
<ul>
<li>Harry Markowitz（1952年提唱, ノーベル賞受賞）。</li>
<li>複数資産の組合せによるポートフォリオ最適化モデル。</li>
<li>目的：効率的ポートフォリオを構築し、リスクを抑えつつリターンを最大化。</li>
</ul>
<hr>
</section>
<section id="基本的考え方" class="level3">
<h3 class="anchored" data-anchor-id="基本的考え方">基本的考え方</h3>
<ul>
<li>単一銘柄投資は高リスク。</li>
<li>複数資産を組み合わせることでリスクを分散（Diversification）。</li>
<li>相関が低い資産を組み合わせるとリスクがさらに低減。</li>
</ul>
<hr>
</section>
<section id="前提条件" class="level3">
<h3 class="anchored" data-anchor-id="前提条件">前提条件</h3>
<ol type="1">
<li>リターンは正規分布に従う。</li>
<li>投資家はリスク回避的（高リターンなら高リスクを取る）。</li>
</ol>
<hr>
</section>
<section id="効率的ポートフォリオefficient-portfolio" class="level3">
<h3 class="anchored" data-anchor-id="効率的ポートフォリオefficient-portfolio">効率的ポートフォリオ（Efficient Portfolio）</h3>
<ul>
<li>与えられたリスクで最大リターン。</li>
<li>または、与えられたリターンで最小リスク。</li>
<li>投資家は自分のリスク許容度に応じて最適な組合せを選択可能。</li>
</ul>
<hr>
<p>👉 MPTの核心は「分散投資」。<br>
👉 次は「ポートフォリオのリターンとリスクの定式化（数式表現）」に進む。</p>
<p>##3-3 MPTの数式定式化（基礎）</p>
</section>
<section id="ポートフォリオの前提" class="level3">
<h3 class="anchored" data-anchor-id="ポートフォリオの前提">ポートフォリオの前提</h3>
<ul>
<li>ショートポジション禁止（全てロング）。</li>
<li>投資比率（weights）は非負で合計1。</li>
<li>投資資産 = 株式（例：Apple, Google, Tesla, GE）。</li>
</ul>
<p>例： - <span class="math inline">\(w = [0.2, 0.3, 0.25, 0.25],  Σw = 1.0\)</span></p>
<hr>
</section>
<section id="基本パラメータ" class="level3">
<h3 class="anchored" data-anchor-id="基本パラメータ">基本パラメータ</h3>
<ul>
<li><span class="math inline">\(w_i\)</span> = 資産iの投資比率</li>
<li><span class="math inline">\(r_i\)</span> = 資産iのリターン（過去データから算出）</li>
<li><span class="math inline">\(E[r_i]\)</span> = 資産iの期待リターン（平均）</li>
</ul>
<hr>
</section>
<section id="リターンの定義" class="level3">
<h3 class="anchored" data-anchor-id="リターンの定義">リターンの定義</h3>
<ol type="1">
<li><strong>通常リターン</strong> <span class="math display">\[
r_t = \frac{S_{t+1} - S_t}{S_t}
\]</span>
<ul>
<li>株価の変化率。</li>
</ul></li>
<li><strong>対数リターン</strong> <span class="math display">\[
r_t = \ln\left(\frac{S_{t+1}}{S_t}\right)
\]</span>
<ul>
<li>数学的に便利、正規化や機械学習で広く利用。</li>
</ul></li>
</ol>
<hr>
</section>
<section id="重要点" class="level3">
<h3 class="anchored" data-anchor-id="重要点">重要点</h3>
<ul>
<li>Weights + Returns + Expected Return がポートフォリオ数式の基礎。</li>
<li>リターン計算では対数リターンを使う方が一般的。</li>
<li>次は「ポートフォリオ期待リターンの計算」に進む。</li>
</ul>
<p>##3-4 ポートフォリオの期待リターン</p>
</section>
<section id="前提" class="level3">
<h3 class="anchored" data-anchor-id="前提">前提</h3>
<ul>
<li>MPTでは「平均リターン」と「分散」を用いて効率的ポートフォリオを求める。</li>
<li>過去の平均リターンを将来の推定値とみなす。</li>
</ul>
<hr>
</section>
<section id="定義" class="level3">
<h3 class="anchored" data-anchor-id="定義">定義</h3>
<ul>
<li><span class="math inline">\(w_i\)</span> = 資産iの投資比率（weights）</li>
<li><span class="math inline">\(r_i\)</span> = 資産iのリターン</li>
<li><span class="math inline">\(μ_i = E[r_i]\)</span>（資産iの期待リターン）</li>
</ul>
<hr>
</section>
<section id="数式" class="level3">
<h3 class="anchored" data-anchor-id="数式">数式</h3>
<p>ポートフォリオの期待リターン： <span class="math display">\[
E[R_p] = \sum_i w_i \, μ_i
\]</span></p>
<p>行列形式： <span class="math display">\[
E[R_p] = w^T μ
\]</span></p>
<hr>
</section>
<section id="ポイント" class="level3">
<h3 class="anchored" data-anchor-id="ポイント">ポイント</h3>
<ul>
<li>期待リターンは「各資産の期待リターン × 投資比率」の加重平均。</li>
<li>ウェイトベクトル w の合計は 1。</li>
<li>次は「ポートフォリオのリスク（分散・共分散行列）」に進む。</li>
</ul>
<p>##3-5 ポートフォリオのリスク</p>
</section>
<section id="共分散" class="level3">
<h3 class="anchored" data-anchor-id="共分散">共分散</h3>
<ul>
<li>2資産のリターンの連動性を表す。</li>
<li>Cov &lt; 0 → 逆相関（リスク低減に有効）。</li>
<li>Cov &gt; 0 → 同方向に動く（分散効果が小さい）。</li>
</ul>
</section>
<section id="共分散行列-σ" class="level3">
<h3 class="anchored" data-anchor-id="共分散行列-σ">共分散行列 Σ</h3>
<ul>
<li>対角要素：各銘柄の分散 Var(Ri)</li>
<li>非対角要素：銘柄間の共分散 Cov(Ri, Rj)</li>
<li>対称行列。</li>
</ul>
</section>
<section id="ポートフォリオ分散" class="level3">
<h3 class="anchored" data-anchor-id="ポートフォリオ分散">ポートフォリオ分散</h3>
<p><span class="math display">\[
\sigma_p^2 = w^T \Sigma w
\]</span></p>
</section>
<section id="標準偏差リスク" class="level3">
<h3 class="anchored" data-anchor-id="標準偏差リスク">標準偏差（リスク）</h3>
<p><span class="math display">\[
\sigma_p = \sqrt{w^T \Sigma w}
\]</span></p>
<hr>
</section>
<section id="ポイント-1" class="level3">
<h3 class="anchored" data-anchor-id="ポイント-1">ポイント</h3>
<ul>
<li>分散（リスク）は銘柄間の共分散も含めて計算される。</li>
<li>相関が低い資産を組み合わせることでリスクを下げられる。</li>
<li>MPTの目的は「リスク最小でリターン最大」の効率的ポートフォリオを見つけること。</li>
</ul>
<p>##3-6 効率的フロンティア</p>
<ul>
<li>横軸：リスク（標準偏差・分散）</li>
<li>縦軸：リターン（期待収益率）</li>
<li>各点：異なるウェイトのポートフォリオ</li>
</ul>
</section>
<section id="効率的フロンティアとは" class="level3">
<h3 class="anchored" data-anchor-id="効率的フロンティアとは">効率的フロンティアとは</h3>
<ul>
<li>同じリスクでより高いリターンを得られるポートフォリオ</li>
<li>同じリターンでより低いリスクを持つポートフォリオ</li>
<li>最適なポートフォリオの集合が「フロンティア」を形成する</li>
</ul>
</section>
<section id="投資家の選択" class="level3">
<h3 class="anchored" data-anchor-id="投資家の選択">投資家の選択</h3>
<ul>
<li>リスクを抑えるなら → 低リスク・低リターン側</li>
<li>高いリターンを狙うなら → 高リスク・高リターン側</li>
<li>自分のリスク許容度に応じてフロンティア上から選択</li>
</ul>
</section>
<section id="結論" class="level3">
<h3 class="anchored" data-anchor-id="結論">結論</h3>
<ul>
<li>収益を得るには必ずリスクを取る必要がある</li>
<li>MPTは「リスクとリターンのバランスを最適化する」ための理論</li>
</ul>
<p>##3-7 Python実装：シャープレシオによる投資評価</p>
</section>
<section id="特徴" class="level3">
<h3 class="anchored" data-anchor-id="特徴">特徴</h3>
<ul>
<li>投資のリスクとリターンを同時に評価できる指標。</li>
<li>期待リターンから無リスク利子率を引き、リスク（標準偏差）で割った値。</li>
<li>値が大きいほど投資効率が良い。</li>
</ul>
<hr>
</section>
<section id="数式-1" class="level3">
<h3 class="anchored" data-anchor-id="数式-1">数式</h3>
<p>Sharpe Ratio = (期待リターン - 無リスク利子率) / 標準偏差</p>
<ul>
<li>期待リターン : 投資やポートフォリオの平均リターン</li>
<li>無リスク利子率 : 国債や銀行預金などの利回り</li>
<li>標準偏差 : リターンの変動（リスクの大きさ）</li>
</ul>
<hr>
</section>
<section id="解釈の目安" class="level3">
<h3 class="anchored" data-anchor-id="解釈の目安">解釈の目安</h3>
<ul>
<li>Sharpe Ratio &gt; 1 : 良い投資</li>
<li>Sharpe Ratio &gt; 2 : とても良い投資</li>
<li>Sharpe Ratio &gt; 3 : 優れた投資（例：ウォーレン・バフェットの投資）</li>
</ul>
<hr>
</section>
<section id="python実装例" class="level3">
<h3 class="anchored" data-anchor-id="python実装例">Python実装例</h3>
<div id="cell-8" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}}" data-outputid="edb39bff-13e8-4e41-c429-f96d3876c465">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sharpe_ratio(returns, risk_free_rate):</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co">    returns: 投資リターンのリスト（例: [0.05, 0.07, 0.02]）</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co">    risk_free_rate: 無リスク利子率（例: 0.01 = 1%）</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    excess_returns <span class="op">=</span> np.array(returns) <span class="op">-</span> risk_free_rate</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.mean(excess_returns) <span class="op">/</span> np.std(excess_returns, ddof<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    returns <span class="op">=</span> [<span class="fl">0.05</span>, <span class="fl">0.07</span>, <span class="fl">0.02</span>, <span class="fl">0.06</span>, <span class="fl">0.04</span>]  <span class="co"># 年ごとのリターン例</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    rf <span class="op">=</span> <span class="fl">0.01</span>  <span class="co"># 無リスク利子率（1%）</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    sr <span class="op">=</span> sharpe_ratio(returns, rf)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Sharpe Ratio:"</span>, sr)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Sharpe Ratio: 1.9755259306581379</code></pre>
</div>
</div>
<p>##3-8 Python実装：キャピタル・アロケーション・ライン（Capital Allocation Line, CAL）</p>
</section>
<section id="特徴-1" class="level3">
<h3 class="anchored" data-anchor-id="特徴-1">特徴</h3>
<ul>
<li>投資家は「リスク資産（株式ポートフォリオ）」と「無リスク資産（国債やTビル）」を組み合わせて投資できる。</li>
<li>無リスク資産のリターンと、最大シャープレシオを持つポートフォリオを結ぶ直線を「キャピタル・アロケーション・ライン（CAL）」と呼ぶ。</li>
<li>CAL上にあるポートフォリオが最適ポートフォリオとなる。</li>
</ul>
<hr>
</section>
<section id="考え方" class="level3">
<h3 class="anchored" data-anchor-id="考え方">考え方</h3>
<ul>
<li>リスクを取りたくない → 無リスク資産のみ（CALの左端）。</li>
<li>一部リスクを取る → 無リスク資産とリスク資産を組み合わせた点（CAL上の中間）。</li>
<li>全額リスク資産 → 最大シャープレシオを持つポートフォリオ（CALの接点）。</li>
<li>さらにリスクを取りたい → 借入をしてリスク資産に追加投資（CALの右側延長）。</li>
</ul>
<hr>
</section>
<section id="数式-2" class="level3">
<h3 class="anchored" data-anchor-id="数式-2">数式</h3>
<p>CAL上の任意のポートフォリオの期待リターンは次の式で表される。</p>
<p><span class="math display">\[E[R_c] = R_f + ( (E[R_p] - R_f) / σ_p ) * σ_c\]</span></p>
<ul>
<li><span class="math inline">\(E[R_c]\)</span> : CAL上のポートフォリオの期待リターン<br>
</li>
<li><span class="math inline">\(R_f\)</span> : 無リスク利子率<br>
</li>
<li><span class="math inline">\(E[R_p]\)</span> : リスク資産ポートフォリオの期待リターン<br>
</li>
<li><span class="math inline">\(σ_p\)</span> : リスク資産ポートフォリオの標準偏差<br>
</li>
<li><span class="math inline">\(σ_c\)</span> : CAL上のポートフォリオの標準偏差</li>
</ul>
<hr>
</section>
<section id="python実装例-1" class="level3">
<h3 class="anchored" data-anchor-id="python実装例-1">Python実装例</h3>
<div id="cell-10" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}}" data-outputid="8f399bd3-3e67-4d98-be4c-7112b7659ef7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> capital_allocation_line(rf, rp, sigma_p, sigma_c):</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co">    rf: 無リスク利子率</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co">    rp: リスク資産ポートフォリオの期待リターン</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co">    sigma_p: リスク資産ポートフォリオの標準偏差</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="co">    sigma_c: 求めたいポートフォリオの標準偏差</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    slope <span class="op">=</span> (rp <span class="op">-</span> rf) <span class="op">/</span> sigma_p  <span class="co"># シャープレシオ</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> rf <span class="op">+</span> slope <span class="op">*</span> sigma_c</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    rf <span class="op">=</span> <span class="fl">0.02</span>      <span class="co"># 無リスク利子率（2%）</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    rp <span class="op">=</span> <span class="fl">0.08</span>      <span class="co"># リスク資産ポートフォリオの期待リターン（8%）</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    sigma_p <span class="op">=</span> <span class="fl">0.15</span> <span class="co"># リスク資産ポートフォリオの標準偏差（15%）</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> sigma_c <span class="kw">in</span> [<span class="fl">0.0</span>, <span class="fl">0.05</span>, <span class="fl">0.1</span>, <span class="fl">0.15</span>, <span class="fl">0.2</span>]:</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>        rc <span class="op">=</span> capital_allocation_line(rf, rp, sigma_p, sigma_c)</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"σ=</span><span class="sc">{</span>sigma_c<span class="sc">:.2f}</span><span class="ss">, 期待リターン=</span><span class="sc">{</span>rc<span class="sc">:.4f}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>σ=0.00, 期待リターン=0.0200
σ=0.05, 期待リターン=0.0400
σ=0.10, 期待リターン=0.0600
σ=0.15, 期待リターン=0.0800
σ=0.20, 期待リターン=0.1000</code></pre>
</div>
</div>
<p>##マーコヴィッツモデルの実装</p>
<p>##3-9 Python実装：株価データの取得と可視化（Markowitzモデル準備）</p>
</section>
<section id="特徴-2" class="level3">
<h3 class="anchored" data-anchor-id="特徴-2">特徴</h3>
<ul>
<li>モダンポートフォリオ理論（Markowitzモデル）の実装準備として、株価データを取得する。</li>
<li>Yahoo! Finance から株価データをダウンロードし、Pandas DataFrame にまとめる。</li>
<li>Matplotlib を用いて可視化する。</li>
</ul>
<hr>
</section>
<section id="使用ライブラリ" class="level3">
<h3 class="anchored" data-anchor-id="使用ライブラリ">使用ライブラリ</h3>
<ul>
<li>numpy</li>
<li>pandas</li>
<li>yfinance（Yahoo! Finance API）</li>
<li>matplotlib</li>
<li>scipy.optimize（後の最適化で使用予定）</li>
</ul>
<hr>
</section>
<section id="手順" class="level3">
<h3 class="anchored" data-anchor-id="手順">手順</h3>
<ol type="1">
<li>対象銘柄のリストを作成<br>
例：Apple, Wal-Mart, Amazon, Deutsche Bank, General Electric, Tesla</li>
<li>取得期間を設定（例：2012年～2017年）</li>
<li>yfinance を用いて株価データ（特に終値）を取得</li>
<li>Pandas DataFrame にまとめる</li>
<li>Matplotlib で株価推移をプロットする</li>
</ol>
<hr>
</section>
<section id="python実装例-2" class="level3">
<h3 class="anchored" data-anchor-id="python実装例-2">Python実装例</h3>
<div id="cell-13" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:704}}" data-outputid="c3f0cf00-195a-48cf-9d83-09ecea9acb7b">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> yfinance <span class="im">as</span> yf</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> download_data(stocks, start, end):</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    stock_data <span class="op">=</span> {}</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> stock <span class="kw">in</span> stocks:</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>        ticker <span class="op">=</span> yf.Ticker(stock)</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>        stock_data[stock] <span class="op">=</span> ticker.history(start<span class="op">=</span>start, end<span class="op">=</span>end)[<span class="st">"Close"</span>]</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(stock_data)</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> show_data(data):</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    data.plot(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    stocks <span class="op">=</span> [<span class="st">"AAPL"</span>, <span class="st">"WMT"</span>, <span class="st">"AMZN"</span>, <span class="st">"DB"</span>, <span class="st">"GE"</span>, <span class="st">"TSLA"</span>]</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    start <span class="op">=</span> <span class="st">"2012-01-01"</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    end <span class="op">=</span> <span class="st">"2017-01-01"</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> download_data(stocks, start, end)</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(data.head())   <span class="co"># データ確認</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>    show_data(data)      <span class="co"># 可視化</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                AAPL        WMT    AMZN         DB         GE  \
Date                                                                            
2012-01-03 00:00:00-05:00  12.345172  15.184759  8.9515  26.521105  67.937828   
2012-01-04 00:00:00-05:00  12.411514  15.028704  8.8755  25.722076  68.677895   
2012-01-05 00:00:00-05:00  12.549308  14.955713  8.8805  24.124020  68.640892   
2012-01-06 00:00:00-05:00  12.680498  14.850002  9.1305  22.812279  69.010948   
2012-01-09 00:00:00-05:00  12.660383  14.895315  8.9280  22.399445  69.787987   

                               TSLA  
Date                                 
2012-01-03 00:00:00-05:00  1.872000  
2012-01-04 00:00:00-05:00  1.847333  
2012-01-05 00:00:00-05:00  1.808000  
2012-01-06 00:00:00-05:00  1.794000  
2012-01-09 00:00:00-05:00  1.816667  </code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>&lt;Figure size 1000x500 with 1 Axes&gt;</code></pre>
</div>
</div>
<p>##3-10 Python実装：リターンとポートフォリオ統計量の計算</p>
</section>
<section id="特徴-3" class="level3">
<h3 class="anchored" data-anchor-id="特徴-3">特徴</h3>
<ul>
<li>株価データから対数リターン（log return）を計算する。</li>
<li>年間平均リターン、分散・共分散行列を算出する。</li>
<li>任意のポートフォリオ（重みベクトル）に対して、期待リターンとリスク（ボラティリティ）を計算する。</li>
</ul>
<hr>
</section>
<section id="数式と定義" class="level3">
<h3 class="anchored" data-anchor-id="数式と定義">数式と定義</h3>
<p>対数リターン（Log Return）:<br>
<span class="math display">\[r_t = ln( S_t / S_{t-1} )\]</span></p>
<p>ポートフォリオ期待リターン:<br>
<span class="math display">\[E[R_p] = (μ ・ w) × 252  \]</span> - <span class="math inline">\(μ\)</span>: ポートフォリオの重みベクトル<br>
- 252 : 年間取引日数</p>
<p>ポートフォリオ分散:<br>
<span class="math display">\[Var(R_p) = w^T Σ w × 252  \]</span> - <span class="math inline">\(Σ\)</span> : リターンの共分散行列<br>
- <span class="math inline">\(w^T\)</span> : 重みベクトルの転置</p>
<p>ポートフォリオ標準偏差（ボラティリティ）:<br>
<span class="math display">\[σ_p = sqrt( Var(R_p) )\]</span></p>
<hr>
</section>
<section id="python実装例-3" class="level3">
<h3 class="anchored" data-anchor-id="python実装例-3">Python実装例</h3>
<div id="cell-15" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}}" data-outputid="c85f3f2b-8efd-4dd2-c428-1a07bbf75082">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> yfinance <span class="im">as</span> yf</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>TRADING_DAYS <span class="op">=</span> <span class="dv">252</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> download_data(stocks, start, end):</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> {}</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> stock <span class="kw">in</span> stocks:</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>        ticker <span class="op">=</span> yf.Ticker(stock)</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>        data[stock] <span class="op">=</span> ticker.history(start<span class="op">=</span>start, end<span class="op">=</span>end)[<span class="st">"Close"</span>]</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(data)</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_log_returns(data):</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>    log_returns <span class="op">=</span> np.log(data <span class="op">/</span> data.shift(<span class="dv">1</span>))</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> log_returns.iloc[<span class="dv">1</span>:]  <span class="co"># 最初の行は NaN なので削除</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> show_statistics(returns):</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    mean_returns <span class="op">=</span> returns.mean() <span class="op">*</span> TRADING_DAYS</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>    cov_matrix <span class="op">=</span> returns.cov() <span class="op">*</span> TRADING_DAYS</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Annual Mean Returns:</span><span class="ch">\n</span><span class="st">"</span>, mean_returns)</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Annual Covariance Matrix:</span><span class="ch">\n</span><span class="st">"</span>, cov_matrix)</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> mean_returns, cov_matrix</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> portfolio_performance(weights, mean_returns, cov_matrix):</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>    port_return <span class="op">=</span> np.dot(mean_returns, weights)</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>    port_variance <span class="op">=</span> np.dot(weights.T, np.dot(cov_matrix, weights))</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>    port_volatility <span class="op">=</span> np.sqrt(port_variance)</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> port_return, port_volatility</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>    stocks <span class="op">=</span> [<span class="st">"AAPL"</span>, <span class="st">"WMT"</span>, <span class="st">"AMZN"</span>, <span class="st">"DB"</span>, <span class="st">"GE"</span>, <span class="st">"TSLA"</span>]</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>    start <span class="op">=</span> <span class="st">"2012-01-01"</span></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>    end <span class="op">=</span> <span class="st">"2017-01-01"</span></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> download_data(stocks, start, end)</span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>    log_returns <span class="op">=</span> calculate_log_returns(data)</span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>    mean_returns, cov_matrix <span class="op">=</span> show_statistics(log_returns)</span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 仮のポートフォリオ（各銘柄に均等投資）</span></span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>    weights <span class="op">=</span> np.array([<span class="dv">1</span><span class="op">/</span><span class="bu">len</span>(stocks)] <span class="op">*</span> <span class="bu">len</span>(stocks))</span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>    port_return, port_volatility <span class="op">=</span> portfolio_performance(weights, mean_returns, cov_matrix)</span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Portfolio Expected Annual Return:"</span>, <span class="bu">round</span>(port_return, <span class="dv">4</span>))</span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Portfolio Volatility (Std Dev):"</span>, <span class="bu">round</span>(port_volatility, <span class="dv">4</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Annual Mean Returns:
 AAPL    0.154803
WMT     0.053214
AMZN    0.287153
DB     -0.128913
GE      0.142554
TSLA    0.406862
dtype: float64

Annual Covariance Matrix:
           AAPL       WMT      AMZN        DB        GE      TSLA
AAPL  0.068351  0.008143  0.019009  0.024571  0.014196  0.025434
WMT   0.008143  0.028017  0.008545  0.013247  0.009221  0.010265
AMZN  0.019009  0.008545  0.094476  0.031574  0.018026  0.041774
DB    0.024571  0.013247  0.031574  0.139114  0.031347  0.039047
GE    0.014196  0.009221  0.018026  0.031347  0.032647  0.019334
TSLA  0.025434  0.010265  0.041774  0.039047  0.019334  0.252700

Portfolio Expected Annual Return: 0.1526
Portfolio Volatility (Std Dev): 0.1858</code></pre>
</div>
</div>
<p>##3-11 Python実装：ランダムポートフォリオ生成と効率的フロンティア</p>
</section>
<section id="特徴-4" class="level3">
<h3 class="anchored" data-anchor-id="特徴-4">特徴</h3>
<ul>
<li>ランダムに重み（weights）を割り当てた多数のポートフォリオを生成する。</li>
<li>各ポートフォリオについて期待リターンとリスク（ボラティリティ）を計算。</li>
<li>結果を散布図で表示し、効率的フロンティア（Efficient Frontier）を可視化。</li>
<li>カラーバーでシャープレシオを示す。</li>
</ul>
<hr>
</section>
<section id="数式-3" class="level3">
<h3 class="anchored" data-anchor-id="数式-3">数式</h3>
<p>ポートフォリオ期待リターン:<br>
<span class="math display">\[E[R_p] = (μ ・ w) × 252  \]</span></p>
<p>ポートフォリオ分散:<br>
<span class="math display">\[Var(R_p) = w^T Σ w × 252  \]</span></p>
<p>ポートフォリオ標準偏差（ボラティリティ）:<br>
<span class="math display">\[σ_p = sqrt(Var(R_p))  \]</span></p>
<p>シャープレシオ（カラーの基準）:<br>
<span class="math display">\[Sharpe Ratio = E[R_p] / σ_p  \]</span></p>
<hr>
</section>
<section id="python実装例-4" class="level3">
<h3 class="anchored" data-anchor-id="python実装例-4">Python実装例</h3>
<div id="cell-17" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:542}}" data-outputid="09faa2ba-2ad4-43b9-9012-2b5233969bc3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>TRADING_DAYS <span class="op">=</span> <span class="dv">252</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_portfolios(mean_returns, cov_matrix, num_portfolios<span class="op">=</span><span class="dv">10000</span>):</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> {<span class="st">"returns"</span>: [], <span class="st">"risks"</span>: [], <span class="st">"weights"</span>: []}</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    num_stocks <span class="op">=</span> <span class="bu">len</span>(mean_returns)</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(num_portfolios):</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>        weights <span class="op">=</span> np.random.random(num_stocks)</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>        weights <span class="op">/=</span> np.<span class="bu">sum</span>(weights)  <span class="co"># 合計が1になるよう正規化</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>        port_return <span class="op">=</span> np.dot(mean_returns, weights)</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>        port_variance <span class="op">=</span> np.dot(weights.T, np.dot(cov_matrix, weights))</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>        port_volatility <span class="op">=</span> np.sqrt(port_variance)</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>        results[<span class="st">"returns"</span>].append(port_return)</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>        results[<span class="st">"risks"</span>].append(port_volatility)</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>        results[<span class="st">"weights"</span>].append(weights)</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (np.array(results[<span class="st">"returns"</span>]),</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>            np.array(results[<span class="st">"risks"</span>]),</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>            np.array(results[<span class="st">"weights"</span>]))</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> show_portfolios(returns, risks):</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>    plt.scatter(risks, returns, c<span class="op">=</span>returns<span class="op">/</span>risks, marker<span class="op">=</span><span class="st">'o'</span>)</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">"Expected Volatility"</span>)</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">"Expected Return"</span>)</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>    plt.colorbar(label<span class="op">=</span><span class="st">"Sharpe Ratio"</span>)</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>    plt.grid(<span class="va">True</span>)</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ダミーデータ例（実際は前講義のmean_returns, cov_matrixを利用）</span></span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>    mean_returns <span class="op">=</span> np.array([<span class="fl">0.12</span>, <span class="fl">0.08</span>, <span class="fl">0.15</span>, <span class="fl">0.03</span>])</span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>    cov_matrix <span class="op">=</span> np.array([</span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>        [<span class="fl">0.04</span>, <span class="fl">0.01</span>, <span class="fl">0.02</span>, <span class="fl">0.0</span>],</span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>        [<span class="fl">0.01</span>, <span class="fl">0.03</span>, <span class="fl">0.01</span>, <span class="fl">0.0</span>],</span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>        [<span class="fl">0.02</span>, <span class="fl">0.01</span>, <span class="fl">0.05</span>, <span class="fl">0.0</span>],</span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>        [<span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.02</span>]</span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>    port_returns, port_risks, port_weights <span class="op">=</span> generate_portfolios(mean_returns, cov_matrix, <span class="dv">5000</span>)</span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>    show_portfolios(port_returns, port_risks)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>&lt;Figure size 1000x600 with 2 Axes&gt;</code></pre>
</div>
</div>
<p>##3-12 Python実装：最適ポートフォリオとシャープレシオ最大化</p>
</section>
<section id="特徴-5" class="level3">
<h3 class="anchored" data-anchor-id="特徴-5">特徴</h3>
<ul>
<li>SciPy の最適化アルゴリズムを用いて、<strong>シャープレシオが最大となるポートフォリオ</strong>を求める。</li>
<li>制約条件：
<ul>
<li>各資産の重みは 0〜1 の範囲。</li>
<li>重みの合計は 1。</li>
</ul></li>
<li>最適化は「最小化」をベースにしているため、<code>-Sharpe Ratio</code> を最小化することでシャープレシオを最大化する。</li>
</ul>
<hr>
</section>
<section id="数式-4" class="level3">
<h3 class="anchored" data-anchor-id="数式-4">数式</h3>
<p>ポートフォリオ期待リターン:<br>
<span class="math display">\[E[R_p] = (μ ・ w) × 252  \]</span></p>
<p>ポートフォリオ標準偏差（ボラティリティ）:<br>
<span class="math display">\[σ_p = sqrt( w^T Σ w × 252 )  \]</span></p>
<p>シャープレシオ:<br>
<span class="math display">\[Sharpe Ratio = E[R_p] / σ_p  \]</span></p>
<hr>
</section>
<section id="python実装例-5" class="level3">
<h3 class="anchored" data-anchor-id="python実装例-5">Python実装例</h3>
<div id="cell-19" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}}" data-outputid="e8df3740-1e70-4084-c508-49339de55587">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> yfinance <span class="im">as</span> yf</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.optimize <span class="im">import</span> minimize</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>TRADING_DAYS <span class="op">=</span> <span class="dv">252</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> statistics(weights, mean_returns, cov_matrix):</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    port_return <span class="op">=</span> np.dot(mean_returns, weights)</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    port_variance <span class="op">=</span> np.dot(weights.T, np.dot(cov_matrix, weights))</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    port_volatility <span class="op">=</span> np.sqrt(port_variance)</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    sharpe_ratio <span class="op">=</span> port_return <span class="op">/</span> port_volatility</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.array([port_return, port_volatility, sharpe_ratio])</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> min_func_sharpe(weights, mean_returns, cov_matrix):</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">-</span>statistics(weights, mean_returns, cov_matrix)[<span class="dv">2</span>]</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> optimize_portfolio(mean_returns, cov_matrix):</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>    num_stocks <span class="op">=</span> <span class="bu">len</span>(mean_returns)</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>    args <span class="op">=</span> (mean_returns, cov_matrix)</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 制約条件：重みの合計が1</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>    constraints <span class="op">=</span> ({<span class="st">'type'</span>: <span class="st">'eq'</span>, <span class="st">'fun'</span>: <span class="kw">lambda</span> x: np.<span class="bu">sum</span>(x) <span class="op">-</span> <span class="dv">1</span>})</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 各資産の重みは0〜1</span></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>    bounds <span class="op">=</span> <span class="bu">tuple</span>((<span class="dv">0</span>, <span class="dv">1</span>) <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(num_stocks))</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 初期値（均等分散）</span></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>    init_guess <span class="op">=</span> num_stocks <span class="op">*</span> [<span class="fl">1.</span> <span class="op">/</span> num_stocks]</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> minimize(min_func_sharpe,</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>                      init_guess,</span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>                      args<span class="op">=</span>args,</span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>                      method<span class="op">=</span><span class="st">"SLSQP"</span>,</span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>                      bounds<span class="op">=</span>bounds,</span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>                      constraints<span class="op">=</span>constraints)</span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result</span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> print_optimal_portfolio(opt_result, mean_returns, cov_matrix):</span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>    opt_weights <span class="op">=</span> opt_result[<span class="st">"x"</span>].<span class="bu">round</span>(<span class="dv">3</span>)</span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a>    ret, vol, sharpe <span class="op">=</span> statistics(opt_weights, mean_returns, cov_matrix)</span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Optimal Weights:"</span>, opt_weights)</span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Expected Return:"</span>, <span class="bu">round</span>(ret, <span class="dv">4</span>))</span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Volatility:"</span>, <span class="bu">round</span>(vol, <span class="dv">4</span>))</span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Sharpe Ratio:"</span>, <span class="bu">round</span>(sharpe, <span class="dv">4</span>))</span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ダミーデータ例（実際は前講義のデータを利用）</span></span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a>    mean_returns <span class="op">=</span> np.array([<span class="fl">0.12</span>, <span class="fl">0.08</span>, <span class="fl">0.15</span>, <span class="fl">0.03</span>])</span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a>    cov_matrix <span class="op">=</span> np.array([</span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a>        [<span class="fl">0.04</span>, <span class="fl">0.01</span>, <span class="fl">0.02</span>, <span class="fl">0.0</span>],</span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a>        [<span class="fl">0.01</span>, <span class="fl">0.03</span>, <span class="fl">0.01</span>, <span class="fl">0.0</span>],</span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a>        [<span class="fl">0.02</span>, <span class="fl">0.01</span>, <span class="fl">0.05</span>, <span class="fl">0.0</span>],</span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a>        [<span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.02</span>]</span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true" tabindex="-1"></a>    opt_result <span class="op">=</span> optimize_portfolio(mean_returns, cov_matrix)</span>
<span id="cb12-60"><a href="#cb12-60" aria-hidden="true" tabindex="-1"></a>    print_optimal_portfolio(opt_result, mean_returns, cov_matrix)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Optimal Weights: [0.243 0.218 0.313 0.227]
Expected Return: 0.1004
Volatility: 0.1232
Sharpe Ratio: 0.8145</code></pre>
</div>
</div>
<p>##3-13 Python実装：最適ポートフォリオの可視化</p>
</section>
<section id="特徴-6" class="level3">
<h3 class="anchored" data-anchor-id="特徴-6">特徴</h3>
<ul>
<li>これまでの実装（平均・分散、ランダムポートフォリオ生成、最適化）を統合。</li>
<li>最適ポートフォリオ（最大シャープレシオ）の重み・期待リターン・リスクを算出。</li>
<li>散布図（効率的フロンティア）上に最適ポートフォリオを緑色の星印で表示。</li>
</ul>
<hr>
</section>
<section id="実行結果の例" class="level3">
<h3 class="anchored" data-anchor-id="実行結果の例">実行結果の例</h3>
<ul>
<li>最適ポートフォリオの期待リターン：約 0.23（23% 年間リターン）</li>
<li>ボラティリティ（リスク）：約 0.19</li>
<li>シャープレシオ：1.22（1以上なので「良い投資」とされる）</li>
<li>投資配分例（各銘柄への比率の合計 = 1）:
<ul>
<li>Apple：約 14%</li>
<li>Tesla：約 16%</li>
<li>General Electric：約 37%</li>
<li>Amazon：約 32%</li>
<li>Wal-Mart, Deutsche Bank：0%</li>
</ul></li>
</ul>
<hr>
</section>
<section id="python実装例-6" class="level3">
<h3 class="anchored" data-anchor-id="python実装例-6">Python実装例</h3>
<div id="cell-21" class="cell" data-outputid="ceb61d05-ada1-4c84-9fc6-61741cb463b2" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:613}}">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_optimal_portfolio(port_returns, port_risks, opt_result, mean_returns, cov_matrix):</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 散布図（ランダムポートフォリオ群）</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    plt.scatter(port_risks, port_returns, c<span class="op">=</span>port_returns<span class="op">/</span>port_risks, marker<span class="op">=</span><span class="st">'o'</span>)</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">"Expected Volatility"</span>)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">"Expected Return"</span>)</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    plt.colorbar(label<span class="op">=</span><span class="st">"Sharpe Ratio"</span>)</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 最適ポートフォリオ（緑の星）</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    opt_weights <span class="op">=</span> opt_result[<span class="st">"x"</span>]</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    opt_return, opt_vol, opt_sharpe <span class="op">=</span> statistics(opt_weights, mean_returns, cov_matrix)</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    plt.scatter(opt_vol, opt_return, c<span class="op">=</span><span class="st">"green"</span>, marker<span class="op">=</span><span class="st">"*"</span>, s<span class="op">=</span><span class="dv">200</span>)</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>    plt.grid(<span class="va">True</span>)</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 結果の表示</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Optimal Weights:"</span>, opt_weights.<span class="bu">round</span>(<span class="dv">3</span>))</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Expected Return:"</span>, <span class="bu">round</span>(opt_return, <span class="dv">4</span>))</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Volatility:"</span>, <span class="bu">round</span>(opt_vol, <span class="dv">4</span>))</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Sharpe Ratio:"</span>, <span class="bu">round</span>(opt_sharpe, <span class="dv">4</span>))</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ダミーデータ例（実際は前講義のmean_returns, cov_matrix, portfoliosを利用）</span></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>    mean_returns <span class="op">=</span> np.array([<span class="fl">0.12</span>, <span class="fl">0.08</span>, <span class="fl">0.15</span>, <span class="fl">0.03</span>, <span class="fl">0.10</span>, <span class="fl">0.05</span>])</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>    cov_matrix <span class="op">=</span> np.random.rand(<span class="dv">6</span>, <span class="dv">6</span>)</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>    cov_matrix <span class="op">=</span> (cov_matrix <span class="op">+</span> cov_matrix.T) <span class="op">/</span> <span class="dv">2</span>  <span class="co"># 対称行列化</span></span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>    np.fill_diagonal(cov_matrix, <span class="fl">0.04</span>)</span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ランダムポートフォリオ生成（例）</span></span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>    port_returns <span class="op">=</span> np.random.rand(<span class="dv">1000</span>)</span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>    port_risks <span class="op">=</span> np.random.rand(<span class="dv">1000</span>)</span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 最適化結果（例: SciPy minimizeで得られる結果オブジェクトを想定）</span></span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">class</span> DummyResult(<span class="bu">dict</span>):</span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>    opt_result <span class="op">=</span> DummyResult(x<span class="op">=</span>np.array([<span class="fl">0.14</span>, <span class="fl">0.0</span>, <span class="fl">0.16</span>, <span class="fl">0.37</span>, <span class="fl">0.32</span>, <span class="fl">0.0</span>]))</span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 可視化と出力</span></span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a>    plot_optimal_portfolio(port_returns, port_risks, opt_result, mean_returns, cov_matrix)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>&lt;Figure size 1000x600 with 2 Axes&gt;</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Optimal Weights: [0.14 0.   0.16 0.37 0.32 0.  ]
Expected Return: 0.0839
Volatility: 0.5936
Sharpe Ratio: 0.1413</code></pre>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>